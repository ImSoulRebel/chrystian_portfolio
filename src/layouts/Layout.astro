---
import {
  PUBLIC_AUTHOR_GIVEN_NAME,
  PUBLIC_SITE_URL,
  PUBLIC_TWITTER_HANDLE,
  PUBLIC_LINKEDIN_URL,
  PUBLIC_LINKEDIN_USERNAME,
  PUBLIC_GITHUB_URL,
  PUBLIC_TWITTER_URL,
  PUBLIC_SITE_TITLE,
  PUBLIC_AUTHOR_FAMILY_NAME,
  PUBLIC_OG_IMAGE_WIDTH,
  PUBLIC_OG_IMAGE_HEIGHT,
  PUBLIC_OG_IMAGE,
  PUBLIC_PROFILE_IMAGE,
  PUBLIC_BASE_PATH,
} from 'astro:env/client';

import {
  getLocaleFromUrl,
  getHreflangUrls,
  useTranslations,
  type Locale,
} from '@utils/i18n';

import { FloatingCTA } from '@components';
import '@styles/global.css';

interface Props {
  title: string;
  description: string;
  locale?: Locale;
  floatingCTAMode?: 'contact' | 'navigate-to-contact';
}

// Detectar el locale: usar prop si se pasa, sino detectar de URL
const propsLocale = Astro.props.locale;
const locale = propsLocale || getLocaleFromUrl(Astro.url);
const t = useTranslations(locale);

// Configurar el modo del FloatingCTA
const { floatingCTAMode } = Astro.props;

// Obtener traducciones por defecto
const defaultSeoTranslations = {
  title: t('seo.title'),
  description: t('seo.description'),
  keywords: t('seo.keywords'),
};

// Generar URLs hreflang
const currentPath = Astro.url.pathname;
const siteUrl = Astro.site?.toString() || PUBLIC_SITE_URL;
// Usar PUBLIC_BASE_PATH explícitamente, con fallback a BASE_URL

const baseUrl = PUBLIC_BASE_PATH || import.meta.env.BASE_URL || '';
const hreflangUrls = getHreflangUrls(currentPath);

const ogImageUrl = new URL(
  `${baseUrl.replace(/\/$/, '')}${PUBLIC_OG_IMAGE || '/og-image.jpg'}`,
  siteUrl
).href;

// Construir URL completa para la imagen de perfil
const profileImageUrl = new URL(
  `${baseUrl.replace(/\/$/, '')}${PUBLIC_PROFILE_IMAGE || '/profile-image.jpg'}`,
  siteUrl
).href;

const {
  title = defaultSeoTranslations.title,
  description = defaultSeoTranslations.description,
  keywords = defaultSeoTranslations.keywords,
  author = PUBLIC_AUTHOR_GIVEN_NAME,
  ogTitle = title,
  ogDescription = description,
  ogImage = ogImageUrl,
  ogUrl = PUBLIC_SITE_URL,
  twitterTitle = title,
  twitterDescription = description,
  twitterImage = ogImage,
  canonicalUrl = ogUrl,
  structuredData,
  additionalMeta = [],
} = Astro.props;

// Schema.org JSON-LD por defecto
// Obtener datos estructurados desde traducciones
const structuredDataTranslations = t<any>('structuredData.person');

const defaultStructuredData = {
  '@context': 'https://schema.org',
  '@type': 'Person',
  name: structuredDataTranslations.name || PUBLIC_AUTHOR_GIVEN_NAME,
  givenName: structuredDataTranslations.givenName,
  familyName: structuredDataTranslations.familyName,
  jobTitle: structuredDataTranslations.jobTitle,
  description: structuredDataTranslations.description,
  url: siteUrl,
  image: profileImageUrl,
  sameAs: [PUBLIC_LINKEDIN_URL, PUBLIC_GITHUB_URL, PUBLIC_TWITTER_URL],
  knowsAbout: structuredDataTranslations.knowsAbout,
  worksFor: {
    '@type': 'Organization',
    name: structuredDataTranslations.worksFor.name,
    description: structuredDataTranslations.worksFor.description,
  },
  hasOccupation: {
    '@type': 'Occupation',
    name: structuredDataTranslations.occupation.name,
    occupationLocation: {
      '@type': 'Place',
      name: structuredDataTranslations.occupation.location,
    },
    skills: structuredDataTranslations.occupation.skills,
    experienceRequirements:
      structuredDataTranslations.occupation.experienceRequirements,
    responsibilities: structuredDataTranslations.occupation.responsibilities,
  },
  seeks: {
    '@type': 'JobPosting',
    name: structuredDataTranslations.seeks.name,
    description: structuredDataTranslations.seeks.description,
  },
};

const finalStructuredData = structuredData || defaultStructuredData;

// Meta locale específicos
const localeSpecificMeta =
  locale === 'es'
    ? {
        ogLocale: 'es_ES',
        language: 'es',
        region: 'ES',
      }
    : {
        ogLocale: 'en_US',
        language: 'en',
        region: 'US',
      };
---

<!doctype html>
<html lang={locale}>
  <head>
    <!-- Meta tags básicos optimizados -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <meta name="keywords" content={keywords} />
    <meta name="author" content={author} />
    <meta name="generator" content={Astro.generator} />
    <meta name="language" content={localeSpecificMeta.language} />

    <!-- Canonical URL -->
    <link rel="canonical" href={canonicalUrl} />

    <!-- Hreflang tags para SEO internacional -->
    <link rel="alternate" hreflang="es" href={hreflangUrls.es} />
    <link rel="alternate" hreflang="en" href={hreflangUrls.en} />
    <link
      rel="alternate"
      hreflang="x-default"
      href={hreflangUrls['x-default']}
    />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content={ogUrl} />
    <meta property="og:title" content={ogTitle} />
    <meta property="og:description" content={ogDescription} />
    <meta property="og:image" content={ogImage} />
    <meta
      property="og:image:width"
      content={String(PUBLIC_OG_IMAGE_WIDTH) || '1200'}
    />
    <meta
      property="og:image:height"
      content={String(PUBLIC_OG_IMAGE_HEIGHT) || '630'}
    />
    <meta property="og:image:alt" content={description} />
    <meta property="og:locale" content={localeSpecificMeta.ogLocale} />
    <meta property="og:site_name" content={PUBLIC_SITE_TITLE} />

    <!-- Twitter Cards -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content={ogUrl} />
    <meta name="twitter:title" content={twitterTitle} />
    <meta name="twitter:description" content={twitterDescription} />
    <meta name="twitter:image" content={twitterImage} />
    <meta name="twitter:image:alt" content={description} />
    <meta name="twitter:creator" content={PUBLIC_TWITTER_HANDLE} />
    <meta name="twitter:site" content={PUBLIC_TWITTER_URL} />

    <!-- Meta tags para reclutadores y buscadores de talento -->
    <meta
      name="robots"
      content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1"
    />
    <meta name="googlebot" content="index, follow" />
    <meta name="bingbot" content="index, follow" />
    <meta name="availability" content="available for hire" />
    <meta name="employment-type" content="full-time, contract, freelance" />
    <meta name="experience-level" content="senior, lead, architect" />
    <meta name="remote-work" content="yes" />
    <meta name="location" content="Spain, Remote, Europe" />
    <meta
      name="industry"
      content="Technology, Software Development, Mobile Applications"
    />

    <!-- LinkedIn específico -->
    <meta property="profile:first_name" content={PUBLIC_AUTHOR_GIVEN_NAME} />
    <meta property="profile:last_name" content={PUBLIC_AUTHOR_FAMILY_NAME} />
    <meta property="profile:username" content={PUBLIC_LINKEDIN_USERNAME} />

    <!-- Meta tags adicionales personalizados -->
    {
      additionalMeta.map(
        (meta: { name?: string; property?: string; content: string }) => (
          <meta
            {...(meta.name && { name: meta.name })}
            {...(meta.property && { property: meta.property })}
            content={meta.content}
          />
        )
      )
    }

    <!-- Structured Data (JSON-LD) -->
    <script
      is:inline
      type="application/ld+json"
      set:html={JSON.stringify(
        finalStructuredData,
        null,
        import.meta.env.DEV ? 2 : 0
      )}
    />

    <!-- Favicon optimizado -->
    <link
      rel="icon"
      type="image/svg+xml"
      href={`${baseUrl.replace(/\/$/, '')}/favicon.svg`}
    />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href={`${baseUrl.replace(/\/$/, '')}/apple-touch-icon.png`}
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href={`${baseUrl.replace(/\/$/, '')}/favicon-32x32.png`}
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href={`${baseUrl.replace(/\/$/, '')}/favicon-16x16.png`}
    />
    <link
      rel="manifest"
      href={`${baseUrl.replace(/\/$/, '')}/site.webmanifest`}
    />

    <!-- Preconnect para optimización de performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

    <!-- Preload de fuentes críticas para mejor LCP -->
    <link
      rel="preload"
      as="style"
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      media="print"
      onload="this.media='all'"
    />

    <!-- DNS prefetch para recursos externos -->
    <link rel="dns-prefetch" href="https://linkedin.com" />
    <link rel="dns-prefetch" href="https://github.com" />

    <!-- Título dinámico -->
    <title>{title}</title>

    <!-- Optimizaciones adicionales -->
    <meta name="color-scheme" content="light dark" />
    <meta name="theme-color" content="#00d4ff" />
    <meta name="msapplication-TileColor" content="#1a1a2e" />
    <meta name="format-detection" content="telephone=no" />
  </head>
  <body>
    <slot />

    <!-- Floating CTA Button -->
    <FloatingCTA locale={locale} mode={floatingCTAMode} />

    <!-- Scripts de optimización -->
    <script>
      import { App } from '@scripts';

      // Initialize main application
      new App();
    </script>
  </body>
</html>

<style>
  /* Color scheme support para mejor integración con temas del SO */
  :root {
    color-scheme: light dark;
  }

  html,
  body {
    margin: 0;
    width: 100%;
    height: 100%;
    scroll-behavior: smooth;
  }

  /* Optimizaciones de performance */
  * {
    box-sizing: border-box;
  }

  /* Mejoras de accesibilidad */
  @media (prefers-reduced-motion: reduce) {
    html {
      scroll-behavior: auto;
    }

    *,
    *::before,
    *::after {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
    }
  }
</style>
