---
import { Image } from 'astro:assets';
import { useTranslations, type Locale } from '@utils/i18n';
import { SvgComponent } from 'astro/types';
import styles from './projectCard.module.css';

interface Props {
  id: string;
  title: string | undefined;
  stack: string | string[] | undefined;
  description: string | undefined;
  impact?: string | undefined;
  image?: (SvgComponent & ImageMetadata) | undefined;
  liveUrl?: string | undefined;
  githubUrl?: string | undefined;
  featured?: boolean;
  locale?: Locale;
  nda?: boolean;
  sector?: string | undefined;
  role?: string | undefined;
  duration?: string | undefined;
  team?: string | undefined;
  metrics?: Array<{ label: string; value: string }> | undefined;
}

const {
  id,
  title,
  stack,
  description,
  impact,
  image,
  liveUrl,
  featured = false,
  locale = 'es',
  nda = false,
  sector,
  role,
  duration,
  team,
  metrics,
} = Astro.props;

const t = useTranslations(locale);
// Convert stack string to array for better display
const techStack = typeof stack === 'string' ? stack.split(' ¬∑ ') : stack || [];
---

<a href={`/${locale}/projects/${id}`} class={styles.cardLink}>
  <article
    class={`${styles.projectCard} ${featured ? styles.featured : ''} ${nda ? styles.nda : ''}`}
  >
    <div class={styles.projectImage}>
      {
        image ? (
          <Image
            src={image}
            alt={title || 'Project Image'}
            loading="lazy"
            width={400}
            height={200}
            class={styles.img}
          />
        ) : (
          <div class={styles.projectPlaceholder}>
            <svg
              width="60"
              height="60"
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M12 2L2 7L12 12L22 7L12 2Z"
                stroke="currentColor"
                stroke-width="2"
                stroke-linejoin="round"
              />
              <path
                d="M2 17L12 22L22 17"
                stroke="currentColor"
                stroke-width="2"
                stroke-linejoin="round"
              />
              <path
                d="M2 12L12 17L22 12"
                stroke="currentColor"
                stroke-width="2"
                stroke-linejoin="round"
              />
            </svg>
          </div>
        )
      }
      <div class={styles.imageOverlay}></div>

      {/* NDA Badge */}
      {
        nda && (
          <div class={styles.ndaBadge}>
            <svg
              width="12"
              height="12"
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M12 2C10.3431 2 9 3.34315 9 5V8H7C5.89543 8 5 8.89543 5 10V20C5 21.1046 5.89543 22 7 22H17C18.1046 22 19 21.1046 19 20V10C19 8.89543 18.1046 8 17 8H15V5C15 3.34315 13.6569 2 12 2Z"
                stroke="currentColor"
                stroke-width="2"
                stroke-linejoin="round"
              />
              <circle cx="12" cy="15" r="2" fill="currentColor" />
            </svg>
            <span>{t('projects.badges.nda')}</span>
          </div>
        )
      }
    </div>

    <div class={styles.projectContent}>
      <div class={styles.projectHeader}>
        <h3 class={styles.projectTitle}>{title}</h3>

        {/* Project Metadata */}
        {
          (sector || role || duration || team) && (
            <div class={styles.projectMeta}>
              {sector && (
                <div class={styles.metaItem}>
                  <span class={styles.metaLabel}>
                    {t('projects.metadata.sector')}:
                  </span>
                  <span class={styles.metaValue}>{sector}</span>
                </div>
              )}
              {role && (
                <div class={styles.metaItem}>
                  <span class={styles.metaLabel}>
                    {t('projects.metadata.role')}:
                  </span>
                  <span class={styles.metaValue}>{role}</span>
                </div>
              )}
            </div>
          )
        }

        {/* Impact Subtitle */}
        {impact && <p class={styles.projectSubtitle}>{impact}</p>}
      </div>

      <p class={styles.projectDescription}>{description}</p>

      {/* Highlighted Metrics */}
      {
        metrics && metrics.length > 0 && (
          <div class={styles.metricsHighlight}>
            {metrics
              .slice(0, 2)
              .map((metric: { label: string; value: string }) => (
                <div class={styles.metricItem}>
                  <span class={styles.metricValue}>{metric.value}</span>
                  <span class={styles.metricLabel}>{metric.label}</span>
                </div>
              ))}
          </div>
        )
      }

      <div class={styles.techStack}>
        {
          techStack
            .slice(0, 4)
            .map((tech: string) => (
              <span class={styles.techTag}>{tech.trim()}</span>
            ))
        }
        {
          techStack.length > 4 && (
            <span class={styles.techTag}>+{techStack.length - 4}</span>
          )
        }
      </div>

      <div class={styles.projectStats}>
        {
          liveUrl && (
            <div class={styles.statItem}>
              <span class={styles.statIcon}>üåê</span>
              <span>{t('projects.stats.inProduction')}</span>
            </div>
          )
        }
        {
          featured && (
            <div class={styles.statItem}>
              <span class={styles.statIcon}>‚≠ê</span>
              <span>{t('projects.stats.featuredProject')}</span>
            </div>
          )
        }
      </div>
    </div>
  </article>
</a>
